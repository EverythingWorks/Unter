{% extends 'base_logged.html' %}

{% block content %}
{% load leaflet_tags %}

    <h3>Plan your ride</h3>

{% if recent_ride_status == 'SET_BY_PASSENGER' or recent_ride_status == 'ACCEPTED' %}

    <h1 style = "text-align: left">Sorry!</h1> <br>
    <h4>You cannot take another ride when previous is in progress. <br>
    Finish your ride to set new one.</h4>
    <br>
    <h2>You can finish your ride here: </h2>
    <center><a href="{% url 'profile_summary' %}"><button>FINISH HERE!</button></a></center>

{% else %}

<form method="POST" class="ride-form">
        {% csrf_token %}

    <div id="mapid" style="height: 40vh; text-shadow: none;"></div>

    <script type="text/javascript">

	var mymap = L.map('mapid').setView([40.728603, -73.986745], 12);

	L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
			'<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
			'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
		id: 'mapbox.streets'
	}).addTo(mymap);

	var popup = L.popup();
    var markerStart = L.marker();
    var markerEnd = L.marker();
    var start_lat, start_lng, end_lat, end_lng;

	function onMapClick(e) {
        markerStart.setLatLng(e.latlng).addTo(mymap);
        start_lat = e.latlng.lat.toFixed(6);
        start_lng = e.latlng.lng.toFixed(6);
        end_lat = e.latlng.lat.toFixed(6);
        end_lng = e.latlng.lng.toFixed(6);

        popup
			.setLatLng(e.latlng)
			.setContent("You choose " + lat + " " + lng)
			.openOn(mymap);
	}

    function getStart(){
        document.getElementById('pickup_longitude'). value = start_lng;
        document.getElementById('pickup_latitude'). value = start_lat;    
    }

    function getEnd(){
        document.getElementById('dropoff_longitude'). value = end_lng;
        document.getElementById('dropoff_latitude'). value = end_lat;    
    }

	mymap.on('click', onMapClick);

    </script>

    <div class = "warnings">
      {% for field in form %}
        {% for error in field.errors %}
          {{ error }} <br>
        {% endfor %}
      {% endfor %}
    </div>

    <h2>First choose point on the map, then click button, please.</h2>

    <center>
<table style="width: 100%">
    <tr  scope = "row">
        <th>
<center>
    <h2>Number of passengers: <span id="demo"></span></h2>
    <div class="slidecontainer">
        <input id="myRange" type="range" min="1" max="4" value="1" class="slider">
    </div>
</center>
    <script>
            var slider = document.getElementById("myRange");
            var output = document.getElementById("demo");
            output.innerHTML = slider.value;

            
            slider.oninput = function() {
              output.innerHTML = this.value;
              document.getElementById("passenger_count").value = slider.value;
            }
    </script>
    </th>
    <th>
         <center><button onclick="getStart();" type="button" class="btn"> CHOOSE START POINT </button></center>
    </th>
    <th>
         <center><button onclick="getEnd();" type="button" class="btn"> CHOOSE END POINT </button></center>
    </th>
    </tr>
    </table>
</center>

<input id="passenger_counte" name="passenger_count" type="hidden" value = "1" class="form-control" required>

    <input id="pickup_longitude" name="pickup_longitude" type="hidden" value="{{pickup_longitude}}" required>
    <input id="pickup_latitude" name="pickup_latitude" type="hidden" value="{{pickup_latitude}}" required>
    <input id="dropoff_longitude" name="dropoff_longitude" type="hidden" value="{{dropoff_longitude}}" required>
    <input id="dropoff_latitude" name="dropoff_latitude" type="hidden" value="{{dropoff_latitude}}" required>
    <input id="passenger_count" name="passenger_count" type="hidden"  value=1 required>

        <br>
        <center><button type="submit">CONTINUE</button></center>
    </form>

{% endif %}

{% endblock %}